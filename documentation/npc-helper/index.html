<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NPC Helper — Code Reference & Explanation</title>
  <meta name="description" content="Comprehensive code reference and explanations for NpcHelper: NpcDefinition.cs, ModEntry.cs, ModScanner.cs (SMAPI mod)." />
  <meta name="author" content="TamKungZ_ @tamkungz" />
  <link rel="icon" type="image/x-icon" href="https://tamkungz.github.io/image/icon_hp.png" />
  <link rel="canonical" href="https://tamkungz.github.io/documentation/npc-helper/" />

  <!-- Open Graph -->
  <meta property="og:title" content="NPC Helper — Code Reference & Explanation" />
  <meta property="og:description" content="Comprehensive code reference and explanations for NpcHelper: NpcDefinition.cs, ModEntry.cs, ModScanner.cs (SMAPI mod)." />
  <meta property="og:image" content="https://tamkungz.github.io/image/icon_hp.png" />
  <meta property="og:url" content="https://tamkungz.github.io/documentation/npc-helper/" />
  <meta property="og:type" content="website" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@tamkungz" />

  <!-- Structured data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "NPC Helper — Code Reference & Explanation",
    "url": "https://tamkungz.github.io/documentation/npc-helper/",
    "description": "Comprehensive code reference and explanations for NpcHelper: NpcDefinition.cs, ModEntry.cs, ModScanner.cs (SMAPI mod).",
    "author": {
      "@type": "Person",
      "name": "TamKungZ_",
      "sameAs": "https://www.nexusmods.com/stardewvalley/mods/41305"
    },
    "publisher": {
      "@type": "Organization",
      "name": "TamKungZ_",
      "logo": {
        "@type": "ImageObject",
        "url": "https://tamkungz.github.io/image/icon_hp.png"
      }
    },
    "sameAs": [
      "https://www.nexusmods.com/stardewvalley/mods/41305"
    ]
  }
  </script>

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a26; --muted:#9fb0bf; --accent:#57e1c4; --accent2:#7bd389;
      --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:linear-gradient(180deg,#071020 0%, #04101a 100%);color:#e6eef3}
    .container{max-width:1100px;margin:28px auto;padding:26px;border-radius:12px;background:var(--panel);box-shadow:0 10px 40px rgba(0,0,0,0.6)}
    header{display:flex;gap:18px;align-items:center}
    .logo{width:64px;height:64px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#052}
    h1{margin:0;font-size:24px}
    p.lead{margin:4px 0 14px;color:var(--muted)}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    a.button{padding:8px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03); color:var(--accent); text-decoration:none;font-weight:600}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:18px}
    .card{background:var(--card);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    h2{margin:4px 0 12px}
    h3{margin:10px 0 8px}
    pre.code{background:#071927;padding:12px;border-radius:8px;overflow:auto;color:#d2f7f0;font-family:var(--mono);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    table th, table td{padding:8px 6px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03);color:var(--muted)}
    .muted{color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--accent);font-weight:700;margin-right:8px}
    footer{margin-top:18px;padding-top:12px;border-top:1px dashed rgba(255,255,255,0.03);color:var(--muted);font-size:13px}
    button.copy{float:right;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--accent);padding:6px 8px;border-radius:8px;cursor:pointer}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .logo{width:56px;height:56px} .container{margin:12px;padding:14px} }
  </style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <div class="logo">NPC</div>
      <div>
        <h1>NPC Helper — Code Reference</h1>
        <p class="lead">In-depth, line-by-line explanation of NpcDefinition.cs, ModEntry.cs and ModScanner.cs from the NPC Helper SMAPI mod. This doc explains structure, responsibilities, runtime behavior and integration points for mod authors.</p>
        <nav>
          <a class="button" href="#files">Files</a>
          <a class="button" href="#npcdef">NpcDefinition</a>
          <a class="button" href="#modentry">ModEntry</a>
          <a class="button" href="#modscanner">ModScanner</a>
          <a class="button" href="#toml">TOML & Content Packs</a>
          <a class="button" href="#faq">FAQ</a>
        </nav>
      </div>
    </header>

    <div class="grid">
      <main>
        <section id="files" class="card">
          <h2>Files covered</h2>
          <p class="small">This reference explains these source files you provided:</p>
          <ul class="small">
            <li>NpcDefinition.cs — in-memory schema for an NPC; used by the mod and by API clients.</li>
            <li>ModEntry.cs — SMAPI entry point: initializes the manager and exposes the API.</li>
            <li>ModScanner.cs — content-pack scanner that reads mod.toml lists and loads referenced NPC TOML files.</li>
          </ul>
        </section>

        <section id="npcdef" class="card" style="margin-top:18px">
          <h2>NpcDefinition.cs — Purpose & usage</h2>
          <p class="small">NpcDefinition is the canonical, in-memory representation of a custom NPC. The mod parses TOML into this class (TomlParser.ParseTomlToDefinition) or a mod author can construct it and register via the runtime API.</p>

          <h3>Fields & their meaning</h3>
          <table>
            <tr><th>Property</th><th>Meaning / Notes</th></tr>
            <tr><td><code>Name</code></td><td>Internal unique key used by the game and mod. No spaces recommended. Required for registration.</td></tr>
            <tr><td><code>DisplayName</code></td><td>Name shown to players. If not set, the Name is used as fallback.</td></tr>
            <tr><td><code>Gender</code></td><td>Token for game usage: "male" or "female". Defaults to "male". Used when injecting Data/Characters and dispositions.</td></tr>
            <tr><td><code>Age</code></td><td>"child", "teen", or "adult". Defaults to "adult".</td></tr>
            <tr><td><code>Manner</code></td><td>"polite", "rude", or "neutral". Tone for dispositions.</td></tr>
            <tr><td><code>SocialAnxiety</code></td><td>Behavior token: "outgoing", "shy", or "neutral".</td></tr>
            <tr><td><code>Optimism</code></td><td>"positive", "negative", "neutral".</td></tr>
            <tr><td><code>BirthdaySeason</code> &amp; <code>BirthdayDay</code></td><td>Season ("spring"/"summer"/"fall"/"winter") and day (1–28) for birthdate injection.</td></tr>
            <tr><td><code>HomeRegion</code></td><td>Game region string used in disposition entries (example: "Town").</td></tr>
            <tr><td><code>DefaultMap</code>, <code>DefaultX</code>, <code>DefaultY</code>, <code>DefaultFacing</code></td><td>Default spawn location &amp; facing used when spawning NPC instances and when warping them back on morning.</td></tr>
            <tr><td><code>Datable</code>, <code>Marriageable</code></td><td>Relationship flags used in Data/NPCDispositions and CharacterData injection.</td></tr>
            <tr><td><code>CustomSpritePath</code>, <code>CustomPortraitPath</code></td><td>Relative path to sprite/portrait files inside <code>SourceDirectory</code>. Optional.</td></tr>
            <tr><td><code>SourceDirectory</code></td><td>Folder where TOML and assets live (set by the loader).</td></tr>
            <tr><td><code>AbsoluteSpritePath</code>, <code>AbsolutePortraitPath</code></td><td>Calculated absolute fallback paths (set during load).</td></tr>
            <tr><td><code>DialoguePath</code>, <code>SchedulePath</code></td><td>Optional separate files for dialogue and schedule; loader honors these.</td></tr>
            <tr><td><code>Dialogue</code></td><td>Dictionary mapping dialogue keys to raw text. Key names match in-game dialogue IDs.</td></tr>
            <tr><td><code>Schedules</code></td><td>List of ScheduleEntry objects parsed from TOML or added by API.</td></tr>
            <tr><td><code>GiftTastes</code>, <code>GiftResponses</code></td><td>Gift preference lists and optional custom response messages (Love/Like/Neutral/Dislike/Hate).</td></tr>
            <tr><td><code>SpriteVariants</code>, <code>PortraitVariants</code></td><td>Mapping of variant key → image path (key can be a location name, season, or custom tag). Values are relative to SourceDirectory or absolute paths.</td></tr>
          </table>

          <h3>Constructor behavior</h3>
          <p class="small">The constructor initializes GiftTastes with empty lists for the five categories so callers can safely add to them without checking for null.</p>

          <h3>How this object is used at runtime</h3>
          <ol class="small">
            <li>TomlParser creates an instance and populates properties from the TOML files.</li>
            <li>NpcManager.Register stores the instance and sets up internal state (e.g., last location tracking).</li>
            <li>On SMAPI AssetRequested events, the manager consults fields like SpriteVariants, Dialogue, and Schedules to inject assets or provide LoadFrom/Edits to the content pipeline.</li>
            <li>On SaveLoaded/DayStarted/UpdateTicked events the manager may spawn NPC instances, warp them to DefaultMap, call TryLoadSchedule(), and invalidate asset caches when appropriate.</li>
          </ol>
        </section>

        <section id="modentry" class="card" style="margin-top:18px">
          <h2>ModEntry.cs — SMAPI integration & API</h2>
          <p class="small">ModEntry is the SMAPI mod entry point class. It creates the NpcManager and exposes a small public API to other mods.</p>

          <h3>Key members</h3>
          <pre class="code" id="modentry-code">
public override void Entry(IModHelper helper)
{
    _manager = new NpcManager(helper, Monitor);
    _manager.Initialize();

    var npcFolder = Path.Combine(helper.DirectoryPath, "NPCs");
    if (!Directory.Exists(npcFolder))
        Directory.CreateDirectory(npcFolder);

    _manager.LoadFromTomlFolder(npcFolder, Path.GetFileName(helper.DirectoryPath));
}

public override object GetApi()
{
    return new NpcHelperApi(_manager);
}
          </pre>
          <button class="copy" data-target="modentry-code">Copy</button>

          <h3>Explanation</h3>
          <ul class="small">
            <li><strong>Entry</strong> is called by SMAPI when the mod starts. It constructs the NpcManager with the helper and monitor (for logging).</li>
            <li>Initialize registers event handlers inside NpcManager (Content.AssetRequested, GameLoop.SaveLoaded, UpdateTicked, DayStarted) — these drive runtime injection and updating.</li>
            <li>The code ensures a local <code>NPCs</code> folder exists under the mod folder and immediately loads any TOML files found there through <code>LoadFromTomlFolder</code>. That lets authors ship example NPCs inside the mod distribution.</li>
            <li><strong>GetApi</strong> returns an API wrapper instance so other mods can call <code>RegisterNpc</code> to add NPCs at runtime without TOML.</li>
          </ul>

          <h3>Public API</h3>
          <pre class="code" id="api-snippet">
public interface INpcHelperApi
{
    void RegisterNpc(string name, NpcDefinition data);
}
public class NpcHelperApi : INpcHelperApi
{
    public void RegisterNpc(string name, NpcDefinition data)
    {
        data.Name = name;
        _manager.Register(data);
    }
}
          </pre>
          <p class="small">Use case: another mod can call <code>var api = (INpcHelperApi) helper.ModRegistry.GetApi("TamKungZ.NpcHelper"); api.RegisterNpc("MyNpc", myDefinition);</code></p>
        </section>

        <section id="modscanner" class="card" style="margin-top:18px">
          <h2>ModScanner.cs — content pack scanning</h2>
          <p class="small">ModScanner iterates owned Content Packs (SMAPI IContentPack) and reads each pack's <code>mod.toml</code> to find a manual list of NPC TOML paths (a simple custom format) and forwards each found file to the same loader used for local files.</p>

          <h3>Public API & constructor</h3>
          <pre class="code" id="modscanner-code">
public ModScanner(IModHelper helper, IMonitor monitor, Action<string, string, string> loadTomlFile)
{
    _helper = helper;
    _monitor = monitor;
    _loadTomlFile = loadTomlFile;
}
          </pre>

          <h3>ScanAndLoad</h3>
          <p class="small">For each content pack returned by <code>_helper.ContentPacks.GetOwned()</code>, it checks for <code>mod.toml</code>. If present, it parses a "NPCs = [ ... ]" line and then tries to locate each referenced TOML file relative to the content pack directory. If found, it calls the <code>_loadTomlFile(fullPath, cp.Manifest.Name, cp.DirectoryPath)</code> action so the main loader can process it (and optionally capture the content pack name and root).</p>

          <h3>ParseManualToml details</h3>
          <p class="small">This parser is intentionally minimal: it finds the first line that starts with "NPCs" and contains square brackets, then extracts comma-separated paths from inside the brackets, trimming quotes and whitespace. Example accepted line:</p>
          <pre class="code">
NPCs = ["NPCs/Rei/Rei.toml", "NPCs/Other/Other.toml"]
          </pre>

          <h3>Limitations & notes</h3>
          <ul class="small">
            <li>The parser is simple and not a full TOML implementation — it will only read a single line listing the NPC TOML paths. Complex mod.toml files may not be parsed.</li>
            <li>Paths must be relative to the content pack directory and must match casing as used by the filesystem.</li>
            <li>Errors reading mod.toml are caught and logged via the provided IMonitor.</li>
          </ul>
        </section>

        <section id="toml" class="card" style="margin-top:18px">
          <h2>TOML usage, dialogue & schedules (practical guide)</h2>

          <h3>Where files go</h3>
          <p class="small">TOML NPC main files are placed either in your mod's <code>Mods/NpcHelper/NPCs/</code> folder, or inside a content pack that lists their path in <code>mod.toml</code>. The loader creates the NPC.SourceDirectory = folder containing that file so relative image paths resolve correctly.</p>

          <h3>Dialogue file loading rules</h3>
          <ol class="small">
            <li>If the main NPC TOML contains lines under the [Dialogue] table, those are used.</li>
            <li>If you use a separate dialogue file (e.g., <code>DialoguePath = "dialogue.toml"</code>), the loader will read that file and merge keys into <code>NpcDefinition.Dialogue</code>.</li>
            <li>Important: when scanning a folder for NPC main TOML files, the loader intentionally ignores filenames exactly named <code>dialogue.toml</code> and <code>schedule.toml</code> (those are loaded only when referenced by a main file).</li>
          </ol>

          <h3>Dialogue syntax highlights</h3>
          <p class="small">Dialogue keys map to values that can include condition variants inside square brackets and alternative variants separated by <code>||</code>. Examples:</p>
          <pre class="code">
[Dialogue]
greeting = "[friendship >= 8] \"Nice to see you!\" || \"Hello.\""
Small_Talk = "You look tired.|You need a snack."
          </pre>
          <p class="small">Supported condition keys &amp; operators: <code>friendship</code>, <code>time</code>, <code>season</code>, <code>mail</code>, <code>hasquest</code> / <code>quest</code>. Operators: <code>=</code>, <code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>.</p>

          <h3>Schedules syntax highlights</h3>
          <p class="small">Schedule entries are created with table arrays <code>[[Schedule]]</code>. Fields include <code>Time</code> (Stardew time-of-day integer, e.g., 600), <code>Map</code>, <code>X</code>, <code>Y</code>, <code>Facing</code>, optional <code>Action</code>, and the new scoping fields <code>Days</code>, <code>Season</code>, <code>Day</code>.</p>
          <pre class="code">
[[Schedule]]
Time = 600
Map = "Bakery"
X = 3
Y = 8
Facing = 2
Days = "Weekday"

[[Schedule]]
Season = "summer"
Day = 12
Time = 900
Map = "Town"
          </pre>
        </section>

        <section id="faq" class="card" style="margin-top:18px">
          <h2>FAQ, debugging & common pitfalls</h2>

          <h3>Why isn't my dialogue.toml loaded?</h3>
          <p class="small">dialogue.toml is only read when the main NPC TOML references it via <code>DialoguePath</code>. When the loader scans a folder for main NPC TOML files it skips files named dialogue.toml and schedule.toml — put them as secondary files and reference them from the main file.</p>

          <h3>Sprites not showing?</h3>
          <p class="small">Ensure the sprite path resolves — the loader tries:
            <ol class="small">
              <li>SpriteVariants by NPC location/player location/season</li>
              <li>CustomSpritePath (relative to SourceDirectory)</li>
              <li><code>sprite.png</code> in SourceDirectory</li>
              <li>AbsoluteSpritePath fallback</li>
            </ol>
            If none of these files exist, the game cannot display the sprite. Check the SMAPI log for "Using custom sprite path" / "No asset found" messages.</p>

          <h3>How to test quickly</h3>
          <ol class="small">
            <li>Place a minimal TOML file in <code>Mods/NpcHelper/NPCs/Example.toml</code> and restart SMAPI.</li>
            <li>Open SMAPI console and search logs for NpcHelper trace/trace messages to verify registration &amp; asset resolution.</li>
            <li>Use a single-line dialogue key like <code>test = "Hello"</code> to verify Dialogue injection.</li>
          </ol>
        </section>

        <footer>
          <div class="small muted">Documentation generated for: NpcDefinition.cs, ModEntry.cs, ModScanner.cs</div>
          <div style="margin-top:8px">Contact: <strong>TamKungZ_</strong> — <a href="mailto:kittiwut.pimpromma@gmail.com" style="color:var(--accent2)">kittiwut.pimpromma@gmail.com</a></div>
          <div style="margin-top:6px" class="small">Find the official mod page: <a href="https://www.nexusmods.com/stardewvalley/mods/41305" style="color:var(--accent)">NPC Helper on NexusMods</a></div>
        </footer>
      </main>

      <aside class="card">
        <h3 class="small">Quick reference</h3>
        <div style="margin:8px 0">
          <div class="badge">v1.0.0</div> <span class="muted">NPC Helper</span>
        </div>
        <h4 class="small">Event hooks used</h4>
        <ul class="small">
          <li><code>Content.AssetRequested</code> — inject assets &amp; data</li>
          <li><code>GameLoop.SaveLoaded</code> — spawn NPC instances, load schedules</li>
          <li><code>GameLoop.UpdateTicked</code> — poll NPC locations to invalidate assets</li>
          <li><code>GameLoop.DayStarted</code> — invalidate assets on season/day change</li>
        </ul>

        <h4 class="small" style="margin-top:10px">Content pack usage</h4>
        <p class="small">Create a SMAPI content pack and include a <code>mod.toml</code> whose NPCs line lists <code>NPCs = ["NPCs/Rei/Rei.toml"]</code>. ModScanner will load each referenced file.</p>

        <h4 class="small" style="margin-top:10px">Example mod.toml line</h4>
        <pre class="code small" id="modtoml-example">NPCs = ["NPCs/Rei/Rei.toml"]</pre>

        <div style="margin-top:12px">
          <a class="button" href="https://tamkungz.github.io/documentation/npc-helper/" target="_blank" rel="noopener">Full docs</a>
          <a class="button" href="https://www.nexusmods.com/stardewvalley/mods/41305" target="_blank" rel="noopener">Nexus page</a>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Copy button behaviour
    document.querySelectorAll('button.copy').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-target');
        const el = document.getElementById(id);
        if (!el) return;
        const text = el.textContent;
        try {
          await navigator.clipboard.writeText(text);
          btn.textContent = 'Copied';
          setTimeout(()=>btn.textContent='Copy',900);
        } catch {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          btn.textContent = 'Copied';
          setTimeout(()=>btn.textContent='Copy',900);
        }
      });
    });

    // Make code blocks selectable on click
    document.querySelectorAll('pre.code').forEach(p=>{
      p.addEventListener('click', ()=> {
        const sel = window.getSelection();
        const range = document.createRange();
        range.selectNodeContents(p);
        sel.removeAllRanges();
        sel.addRange(range);
      });
    });
  </script>
</body>
</html>
